<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grocery List</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4A7C20">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FAF8F3;
            min-height: 100vh;
            padding: 0;
        }
        
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #FAF8F3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .header {
            text-align: center;
            color: #2D5016;
            padding: 20px 20px 16px;
        }
        
        .header h1 {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 36px;
            font-weight: 400;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #4A7C20;
            font-size: 14px;
        }
        
        .list-container {
            padding: 16px 20px 40px;
            max-width: 440px;
            margin: 0 auto;
        }
        
        .add-item-wrapper {
            padding: 0 20px 20px;
            max-width: 440px;
            margin: 0 auto;
        }
        
        .add-item-field {
            background: white;
            border: 2px dashed #D4CDBD;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .add-item-field:focus-within {
            border-color: #4A7C20;
            border-style: solid;
            box-shadow: 0 4px 12px rgba(74, 124, 32, 0.1);
        }
        
        .add-item-field input {
            flex: 1;
            border: none;
            font-size: 16px;
            background: transparent;
            outline: none;
            color: #2D5016;
        }
        
        .add-item-field input::placeholder {
            color: #A8A292;
        }
        
        .item {
            background: white;
            border: 1px solid #E8E3D3;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .item.swiping {
            transition: none;
        }
        
        .item.done {
            opacity: 0.7;
            background: #FDFCF8;
        }
        
        .item.done .item-text {
            text-decoration: line-through;
            color: #A8A292;
        }
        
        .item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            position: relative;
            background: inherit;
            z-index: 2;
        }
        
        .delete-background {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            background: #D4674A;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .item.show-delete .delete-background {
            opacity: 1;
        }
        
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #D4CDBD;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }
        
        .item.done .checkbox {
            background: #4A7C20;
            border-color: #4A7C20;
        }
        
        .item.done .checkbox::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
        }
        
        .item-text {
            flex: 1;
            font-size: 16px;
            color: #2D5016;
            word-break: break-word;
            user-select: none;
        }
        
        .empty-state {
            text-align: center;
            color: #6B8E59;
            padding: 40px;
            font-size: 18px;
            font-family: Georgia, 'Times New Roman', serif;
        }
        
        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #D4674A;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            animation: pulse 2s infinite;
            z-index: 200;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @media (max-width: 400px) {
            .header h1 {
                font-size: 32px;
            }
            
            .list-container {
                padding: 0 16px 40px;
            }
        }
    </style>
</head>
<body>
    <div class="sticky-top">
        <div class="header">
            <h1>Grocery List</h1>
            <p>Synced in real-time</p>
        </div>
        
        <div class="add-item-wrapper">
            <div class="add-item-field">
                <input type="text" id="newItem" placeholder="Add item..." autocomplete="off" enterkeyhint="done">
            </div>
        </div>
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">Offline</div>
    
    <div class="list-container">
        <div id="list">
            <div class="empty-state">Your grocery list is empty</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.log('The current browser does not support offline persistence');
                }
            });
        
        // References
        const itemsRef = db.collection('groceries');
        const listEl = document.getElementById('list');
        const newItemInput = document.getElementById('newItem');
        const offlineIndicator = document.getElementById('offlineIndicator');
        
        // Track items
        let items = new Map();
        
        // Listen for real-time updates
        itemsRef.orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const doc = change.doc;
                const data = { id: doc.id, ...doc.data() };
                
                if (change.type === 'added') {
                    items.set(doc.id, data);
                    if (!document.getElementById(doc.id)) {
                        addItemToDOM(data);
                    }
                } else if (change.type === 'modified') {
                    items.set(doc.id, data);
                    updateItemInDOM(data);
                } else if (change.type === 'removed') {
                    items.delete(doc.id);
                    removeItemFromDOM(doc.id);
                }
            });
            
            updateEmptyState();
        }, (error) => {
            console.error('Error listening to changes:', error);
        });
        
        // Add item
        function addItem() {
            const text = newItemInput.value.trim();
            if (!text) return;
            
            itemsRef.add({
                text: text,
                done: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                newItemInput.value = '';
                // Keep focus on input for rapid entry
                newItemInput.focus();
            }).catch((error) => {
                console.error('Error adding item:', error);
                alert('Failed to add item. Please try again.');
            });
        }
        
        // Toggle item done status
        function toggleItem(id) {
            const item = items.get(id);
            if (item) {
                itemsRef.doc(id).update({
                    done: !item.done
                }).catch((error) => {
                    console.error('Error toggling item:', error);
                });
            }
        }
        
        // Delete item
        function deleteItem(id) {
            itemsRef.doc(id).delete().catch((error) => {
                console.error('Error deleting item:', error);
                alert('Failed to delete item. Please try again.');
            });
        }
        
        // DOM manipulation functions
        function addItemToDOM(item) {
            const itemEl = document.createElement('div');
            itemEl.className = `item ${item.done ? 'done' : ''}`;
            itemEl.id = item.id;
            itemEl.innerHTML = `
                <div class="delete-background">Delete</div>
                <div class="item-content">
                    <div class="checkbox" onclick="toggleItem('${item.id}')"></div>
                    <div class="item-text">${escapeHtml(item.text)}</div>
                </div>
            `;
            
            // Add swipe listeners
            addSwipeListeners(itemEl);
            
            // Always insert at the top of the list (after empty state if present)
            const firstItem = listEl.querySelector('.item');
            if (firstItem) {
                listEl.insertBefore(itemEl, firstItem);
            } else {
                listEl.appendChild(itemEl);
            }
        }
        
        function addSwipeListeners(itemEl) {
            const content = itemEl.querySelector('.item-content');
            let startX = 0;
            let currentX = 0;
            let startY = 0;
            let isDragging = false;
            let swipeThreshold = 80;
            
            // Touch events
            content.addEventListener('touchstart', handleStart, { passive: true });
            content.addEventListener('touchmove', handleMove, { passive: false });
            content.addEventListener('touchend', handleEnd);
            
            // Mouse events for testing
            content.addEventListener('mousedown', handleStart);
            content.addEventListener('mousemove', handleMove);
            content.addEventListener('mouseup', handleEnd);
            content.addEventListener('mouseleave', handleEnd);
            
            function handleStart(e) {
                isDragging = true;
                startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                currentX = startX;
                itemEl.classList.add('swiping');
            }
            
            function handleMove(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                
                const diffX = currentX - startX;
                const diffY = currentY - startY;
                
                // Only swipe if horizontal movement is greater than vertical
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    // Only allow left swipe
                    if (diffX < 0) {
                        content.style.transform = `translateX(${diffX}px)`;
                        const opacity = Math.min(Math.abs(diffX) / swipeThreshold, 1);
                        itemEl.querySelector('.delete-background').style.opacity = opacity;
                    }
                }
            }
            
            function handleEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                
                const diffX = currentX - startX;
                itemEl.classList.remove('swiping');
                
                if (diffX < -swipeThreshold) {
                    // Delete animation
                    content.style.transform = `translateX(-100%)`;
                    itemEl.querySelector('.delete-background').style.opacity = 1;
                    setTimeout(() => {
                        deleteItem(itemEl.id);
                    }, 300);
                } else {
                    // Snap back
                    content.style.transform = '';
                    itemEl.querySelector('.delete-background').style.opacity = 0;
                }
            }
        }
        
        function updateItemInDOM(item) {
            const itemEl = document.getElementById(item.id);
            if (itemEl) {
                itemEl.className = `item ${item.done ? 'done' : ''}`;
            }
        }
        
        function removeItemFromDOM(id) {
            const itemEl = document.getElementById(id);
            if (itemEl) {
                itemEl.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => itemEl.remove(), 300);
            }
        }
        
        function updateEmptyState() {
            const hasItems = listEl.querySelector('.item');
            const emptyState = listEl.querySelector('.empty-state');
            
            if (!hasItems && !emptyState) {
                listEl.innerHTML = '<div class="empty-state">Your grocery list is empty</div>';
            } else if (hasItems && emptyState) {
                emptyState.remove();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Handle enter key
        newItemInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addItem();
            }
        });
        
        // Auto-focus on load
        window.addEventListener('load', () => {
            newItemInput.focus();
        });
        
        // Online/offline detection
        window.addEventListener('online', () => {
            offlineIndicator.style.display = 'none';
        });
        
        window.addEventListener('offline', () => {
            offlineIndicator.style.display = 'block';
        });
        
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>